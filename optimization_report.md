# 多模态联合 JSCC 模型优化建议报告

> 说明：本报告基于现有问题分析清单逐条给出可执行的优化与改进方案，并标注改动难度与预期收益。

## 问题 1：ImageJSCCDecoder 输出结构与“无跳连导致模糊”
**优化建议：**
1. 引入 U-Net 风格跳跃连接：在编码器与解码器对齐分辨率处拼接/相加特征，保留高频细节。伪代码：
   ```python
   # encoder: feats = [f1, f2, f3, f4]
   # decoder: d4 -> d3 -> d2 -> d1
   d3 = up(d4) + proj(f3)
   d2 = up(d3) + proj(f2)
   d1 = up(d2) + proj(f1)
   out = head(d1)
   ```
2. 加入多尺度残差块：在解码阶段加入不同尺度的残差路径，增强细节恢复能力。
3. 在 PixelShuffle 前增加轻量注意力模块（SE/CBAM），增强局部细节重建的表达能力。

**改动难度：** 中

**预期收益：** 重建质量、细节纹理恢复

---

## 问题 2：VideoJSCCDecoder 推理阶段 ConvLSTM 状态未重置
**优化建议：**
1. 推理滑窗开始前显式 reset：为推理入口增加 `reset_state=True` 或 `model.reset_hidden_states()`。
2. 在解码器内部添加窗口边界检测：若 `window_idx == 0` 或 `is_new_clip`，自动清空状态。
3. 提供可配置状态策略：支持 `"reset" | "carry" | "decay"`，使推理可控。

**改动难度：** 低

**预期收益：** 稳定性、跨窗口一致性

---

## 问题 3：Video guide vector 维度是否匹配
**优化建议：**
1. 维度对齐已正确，无需立即修复。
2. 可在初始化阶段添加断言（shape check），防止后续改动引入维度不一致。

**改动难度：** 低

**预期收益：** 稳定性（避免未来回归）

---

## 问题 4：TextLoss 近零：对比损失使用了“编码特征”
**优化建议：**
1. 使用重建图像特征：将解码输出 `x_hat` 再送入图像编码器得到 `feat_recon` 作为对比特征。
2. 多分支对比损失：同时对 `image_encoded` 与 `feat_recon` 计算 contrastive loss，并加入权重 `alpha` 平衡语义与重建。
3. 引入感知损失或 CLIP-based 对齐：增强语义一致性而非仅依赖编码特征。

**改动难度：** 中

**预期收益：** 语义一致性、重建质量

---

## 问题 5：PatchEmbed 输出过小导致功率归一化放大噪声
**优化建议：**
1. 功率归一化加上上限：例如 `gain = min(gain, max_gain)` 防止极端放大。
2. 训练初期禁用归一化：前 N 个 step 或 epoch 只做标准化，不做增益放大。
3. 调整初始化/增加正则：如增大 PatchEmbed 初始化尺度或加 L2 正则，避免过小输出。

**改动难度：** 中

**预期收益：** 稳定性、训练收敛性

---

## 问题 6：视频解码器光流残差阈值 0.05 固定
**优化建议：**
1. 将阈值暴露为配置项（如 `flow_residual_thresh`），便于不同数据集调参。
2. 使用软权重替代硬阈值：例如 `weight = sigmoid(k * (|res| - t))`。
3. 自适应阈值：基于当前批次或全局统计动态调整阈值。

**改动难度：** 低-中

**预期收益：** 稳定性、重建质量

---

## 问题 7：滑窗推理的重叠平均导致模糊
**优化建议：**
1. 使用余弦或线性权重融合：对重叠区域设置权重，边界更平滑、减少鬼影。
2. 基于置信度/运动信息的自适应融合：在运动剧烈区域降低平均权重。
3. 增加重叠区域的小型修复网络：对融合后的区域进行细节修复。

**改动难度：** 中

**预期收益：** 重建质量、时序一致性

---

## 问题 8：多模态共用 AWGNChannel 是否引入噪声相关
**优化建议：**
1. 目前无噪声相关风险，无需立即修复。
2. 可在通道实现中添加随机种子隔离选项，方便调试或复现实验。

**改动难度：** 低

**预期收益：** 稳定性、可复现性

---

## 问题 9：推理阶段语义文本引导是否正确传入解码器
**优化建议：**
1. 参数传入正确，无需修改。
2. 建议加断言或日志：记录引导向量是否为空，避免未来改动引入遗漏。

**改动难度：** 低

**预期收益：** 稳定性

---

## 问题 10：guide_gate / cross_attention / MultiModalCrossAttention 使用情况
**优化建议：**
1. 若 MultiModalCrossAttention 无使用场景，删除死代码并清理调用路径。
2. 若需使用，明确接口：在 `ImageJSCCDecoder` 或 `VideoJSCCDecoder` 中插入联合注意力模块。
3. 与 guide_gate 形成闭环：在 cross attention 后引入门控，控制文本引导对视觉分支的影响。

**改动难度：** 中-高

**预期收益：** 语义一致性、重建质量、可维护性

---

## 优先级建议（Top 3）
1. **问题 2：ConvLSTM 状态未重置** —— 直接影响推理稳定性，且修复成本低。
2. **问题 4：TextLoss 特征选择不当** —— 影响语义一致性与重建质量，收益明显。
3. **问题 7：滑窗重叠平均导致模糊** —— 影响视频推理视觉效果，改善可显著提升观感。
